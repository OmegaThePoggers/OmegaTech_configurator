---
phase: 10
plan: 1
wave: 1
depends_on: []
files_modified:
  - .env.local
  - src/app/api/create-order/route.ts
  - src/app/api/verify-payment/route.ts
autonomous: true
must_haves:
  truths:
    - "Razorpay SDK is installed (razorpay npm package)"
    - ".env.local template exists with RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET"
    - "POST /api/create-order creates a Razorpay order and returns order ID"
    - "POST /api/verify-payment verifies payment signature"
    - "Order data is validated before creating Razorpay order"
  artifacts:
    - "src/app/api/create-order/route.ts is functional"
    - "src/app/api/verify-payment/route.ts is functional"
---

# Plan 10.1: Razorpay Backend (API Routes)

<objective>
Install the Razorpay SDK, create .env.local template, and build two Next.js API routes:
1. `/api/create-order` — creates a Razorpay order with the cart total
2. `/api/verify-payment` — verifies the payment signature after checkout

Purpose: Backend infrastructure for Razorpay payment flow.
Output: Two working API routes ready for the frontend checkout button.
</objective>

<context>
Load for context:
- src/app/checkout/page.tsx (will call these APIs)
- src/context/CartContext.tsx (cart data types)
</context>

<tasks>

<task type="auto">
  <name>Install Razorpay and Create Env Template</name>
  <files>.env.local, .env.example</files>
  <action>
    1. Install the Razorpay Node.js SDK:
       ```bash
       npm install razorpay
       ```

    2. Create `.env.example` (committed to repo — shows what's needed):
       ```
       # Razorpay Test Mode Keys
       # Get these from https://dashboard.razorpay.com/app/keys
       RAZORPAY_KEY_ID=rzp_test_xxxxxxxxxxxx
       RAZORPAY_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
       NEXT_PUBLIC_RAZORPAY_KEY_ID=rzp_test_xxxxxxxxxxxx
       ```

    3. Create `.env.local` (gitignored — actual values):
       ```
       RAZORPAY_KEY_ID=rzp_test_xxxxxxxxxxxx
       RAZORPAY_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
       NEXT_PUBLIC_RAZORPAY_KEY_ID=rzp_test_xxxxxxxxxxxx
       ```

    4. Make sure `.env.local` is in `.gitignore` (should be by default in Next.js).

    AVOID: Committing real keys — use placeholder test values.
    NOTE: NEXT_PUBLIC_ prefix is needed for client-side Razorpay key access.
  </action>
  <verify>node -e "require('razorpay')"</verify>
  <done>razorpay package installed, .env.example committed with placeholder keys.</done>
</task>

<task type="auto">
  <name>Create Order and Verify Payment API Routes</name>
  <files>src/app/api/create-order/route.ts, src/app/api/verify-payment/route.ts</files>
  <action>
    1. **Create `/api/create-order`** (`src/app/api/create-order/route.ts`):
       ```ts
       import Razorpay from 'razorpay';
       import { NextResponse } from 'next/server';

       const razorpay = new Razorpay({
         key_id: process.env.RAZORPAY_KEY_ID!,
         key_secret: process.env.RAZORPAY_KEY_SECRET!,
       });

       export async function POST(request: Request) {
         const { amount, currency = 'INR', receipt, notes } = await request.json();

         // Validate
         if (!amount || amount <= 0) {
           return NextResponse.json({ error: 'Invalid amount' }, { status: 400 });
         }

         const order = await razorpay.orders.create({
           amount: amount * 100, // Razorpay expects paise
           currency,
           receipt: receipt || `order_${Date.now()}`,
           notes: notes || {},
         });

         return NextResponse.json({
           orderId: order.id,
           amount: order.amount,
           currency: order.currency,
         });
       }
       ```

    2. **Create `/api/verify-payment`** (`src/app/api/verify-payment/route.ts`):
       ```ts
       import crypto from 'crypto';
       import { NextResponse } from 'next/server';

       export async function POST(request: Request) {
         const {
           razorpay_order_id,
           razorpay_payment_id,
           razorpay_signature,
         } = await request.json();

         const body = razorpay_order_id + '|' + razorpay_payment_id;
         const expectedSignature = crypto
           .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET!)
           .update(body)
           .digest('hex');

         const isValid = expectedSignature === razorpay_signature;

         if (isValid) {
           return NextResponse.json({
             verified: true,
             paymentId: razorpay_payment_id,
             orderId: razorpay_order_id,
           });
         } else {
           return NextResponse.json(
             { verified: false, error: 'Invalid signature' },
             { status: 400 }
           );
         }
       }
       ```

    AVOID: Storing payment data in a database for now — just verify and return.
    AVOID: Using any middleware or auth — keep it simple.
  </action>
  <verify>npm run build</verify>
  <done>Both API routes exist and build successfully. /api/create-order creates Razorpay orders, /api/verify-payment validates signatures.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] razorpay package is in node_modules
- [ ] .env.example exists with placeholder keys
- [ ] Both API routes compile without errors
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
