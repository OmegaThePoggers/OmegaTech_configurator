---
phase: 10
plan: 1
wave: 1
depends_on: []
files_modified:
  - .env.example
  - .env.local
  - src/app/api/create-checkout/route.ts
autonomous: true
must_haves:
  truths:
    - "stripe npm package is installed"
    - ".env.example exists with STRIPE_SECRET_KEY and NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY placeholders"
    - "POST /api/create-checkout creates a Stripe Checkout Session and returns the session URL"
  artifacts:
    - "src/app/api/create-checkout/route.ts is functional"
---

# Plan 10.1: Stripe Backend (API Route)

<objective>
Install the Stripe SDK, create .env.example with test key placeholders, and build a Next.js API route that creates a Stripe Checkout Session. Stripe Checkout handles the entire payment form — no custom card UI needed.

Purpose: Backend infrastructure for Stripe payment flow.
Output: One working API route that creates a Checkout Session.
</objective>

<context>
Load for context:
- src/app/checkout/page.tsx (will call this API)
- src/lib/checkout.ts (getCheckoutItems)
</context>

<tasks>

<task type="auto">
  <name>Install Stripe and Create Env Template</name>
  <files>.env.local, .env.example</files>
  <action>
    1. Install the Stripe Node.js SDK:
       ```bash
       npm install stripe
       ```

    2. Create `.env.example` (committed to repo):
       ```
       # Stripe Test Mode Keys
       # Get these from https://dashboard.stripe.com/test/apikeys
       STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxx
       NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxx
       ```

    3. Create `.env.local` with the same placeholder values.

    4. Verify `.env.local` is in `.gitignore`.

    AVOID: Committing real keys.
  </action>
  <verify>node -e "require('stripe')"</verify>
  <done>stripe package installed, .env.example committed with placeholder keys.</done>
</task>

<task type="auto">
  <name>Create Stripe Checkout Session API Route</name>
  <files>src/app/api/create-checkout/route.ts</files>
  <action>
    Create `/api/create-checkout` (`src/app/api/create-checkout/route.ts`):

    ```ts
    import Stripe from 'stripe';
    import { NextResponse } from 'next/server';

    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
      apiVersion: '2024-12-18.acacia',
    });

    export async function POST(request: Request) {
      const { items, origin } = await request.json();

      // items: [{ name, category, price }]
      if (!items || items.length === 0) {
        return NextResponse.json({ error: 'No items' }, { status: 400 });
      }

      const line_items = items.map((item: { name: string; category: string; price: number }) => ({
        price_data: {
          currency: 'inr',
          product_data: {
            name: item.name,
            description: item.category,
          },
          unit_amount: Math.round(item.price * 100), // paise
        },
        quantity: 1,
      }));

      const session = await stripe.checkout.sessions.create({
        mode: 'payment',
        line_items,
        success_url: `${origin}/checkout/confirmation?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${origin}/checkout`,
      });

      return NextResponse.json({ url: session.url });
    }
    ```

    Stripe Checkout handles all payment UI (card form, UPI, etc.) on Stripe's hosted page. After payment, user is redirected back to our confirmation page with the session ID.

    AVOID: Building a custom payment form — Stripe Checkout handles everything.
    AVOID: Any webhook logic for now — just redirect-based flow.
  </action>
  <verify>npm run build</verify>
  <done>API route builds and creates Stripe Checkout Sessions with line items from the cart.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] stripe package in node_modules
- [ ] .env.example exists
- [ ] API route compiles without errors
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
