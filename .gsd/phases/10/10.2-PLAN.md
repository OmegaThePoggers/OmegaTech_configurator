---
phase: 10
plan: 2
wave: 2
depends_on: ["10.1"]
files_modified:
  - src/app/checkout/page.tsx
  - src/app/checkout/confirmation/page.tsx
  - src/lib/orders.ts
autonomous: true
must_haves:
  truths:
    - "Checkout page has a 'Pay with Razorpay' button"
    - "Clicking the button opens the Razorpay payment modal"
    - "After successful payment, user is redirected to confirmation page"
    - "Confirmation page shows order ID, payment ID, and itemized receipt"
    - "Orders are saved to localStorage for order history"
    - "Razorpay script is loaded via next/script"
  artifacts:
    - "src/app/checkout/page.tsx has Razorpay integration"
    - "src/app/checkout/confirmation/page.tsx shows order receipt"
---

# Plan 10.2: Razorpay Checkout UI

<objective>
Integrate the Razorpay checkout button into the /checkout page. When clicked, it creates an order via the API, opens the Razorpay payment modal, verifies the payment, saves the order, and redirects to a confirmation page.

Purpose: Complete the payment flow from checkout to order confirmation.
Output: Working end-to-end payment flow with Razorpay test mode.
</objective>

<context>
Load for context:
- src/app/checkout/page.tsx (existing checkout page)
- src/app/api/create-order/route.ts (from Plan 10.1)
- src/app/api/verify-payment/route.ts (from Plan 10.1)
</context>

<tasks>

<task type="auto">
  <name>Create Order Storage Utility</name>
  <files>src/lib/orders.ts</files>
  <action>
    Create a localStorage utility for orders similar to src/lib/storage.ts:

    ```ts
    type OrderItem = { name: string; category: string; price: number };

    type SavedOrder = {
      id: string;
      razorpayOrderId: string;
      razorpayPaymentId: string;
      items: OrderItem[];
      totalAmount: number;
      status: 'completed';
      createdAt: string;
    };

    export function getOrders(): SavedOrder[]
    export function saveOrder(order: Omit<SavedOrder, 'createdAt'>): void
    ```

    Store under localStorage key `omegatech_orders`.

    AVOID: Complex order management — just save and retrieve.
  </action>
  <verify>npm run build</verify>
  <done>src/lib/orders.ts exports getOrders and saveOrder functions.</done>
</task>

<task type="auto">
  <name>Integrate Razorpay into Checkout Page + Confirmation</name>
  <files>src/app/checkout/page.tsx, src/app/checkout/confirmation/page.tsx</files>
  <action>
    1. **Add Razorpay script** to the checkout page using next/script:
       ```tsx
       import Script from 'next/script';
       // In JSX:
       <Script src="https://checkout.razorpay.com/v1/checkout.js" />
       ```

    2. **Add "Pay with Razorpay" button** below the Grand Total card:
       - Full-width, prominent styling (bg-blue-600, text-white)
       - Shows total amount on the button: "Pay ₹1,20,370 with Razorpay"

    3. **Implement payment handler**:
       ```ts
       const handlePayment = async () => {
         // 1. Create order via API
         const res = await fetch('/api/create-order', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ amount: totalPrice }),
         });
         const { orderId } = await res.json();

         // 2. Open Razorpay modal
         const options = {
           key: process.env.NEXT_PUBLIC_RAZORPAY_KEY_ID,
           amount: totalPrice * 100,
           currency: 'INR',
           name: 'OmegaTech',
           description: 'PC Components Purchase',
           order_id: orderId,
           handler: async (response) => {
             // 3. Verify payment
             const verifyRes = await fetch('/api/verify-payment', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(response),
             });
             const data = await verifyRes.json();
             if (data.verified) {
               // 4. Save order
               saveOrder({ ... });
               // 5. Redirect to confirmation
               router.push(`/checkout/confirmation?orderId=${orderId}&paymentId=${response.razorpay_payment_id}`);
             }
           },
           prefill: { name: '', email: '', contact: '' },
           theme: { color: '#18181b' },
         };

         const rzp = new window.Razorpay(options);
         rzp.open();
       };
       ```

    4. **Create confirmation page** (`src/app/checkout/confirmation/page.tsx`):
       - Read orderId and paymentId from URL search params
       - Show success checkmark animation
       - Display: Order ID, Payment ID, itemized receipt, total
       - "Back to Home" and "View Orders" buttons
       - Green success theme

    5. Add `declare global { interface Window { Razorpay: any } }` for TypeScript.

    AVOID: Storing sensitive payment data — only IDs.
    AVOID: Auto-clearing the cart after payment (let user do it manually).
  </action>
  <verify>npm run build</verify>
  <done>Checkout has "Pay with Razorpay" button that opens modal. After payment, redirects to confirmation with receipt.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Checkout page loads Razorpay script
- [ ] "Pay with Razorpay" button is visible with amount
- [ ] Confirmation page renders with order details
- [ ] Build passes cleanly
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
