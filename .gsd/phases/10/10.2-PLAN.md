---
phase: 10
plan: 2
wave: 2
depends_on: ["10.1"]
files_modified:
  - src/app/checkout/page.tsx
  - src/app/checkout/confirmation/page.tsx
  - src/lib/orders.ts
autonomous: true
must_haves:
  truths:
    - "Checkout page has a 'Pay with Stripe' button showing the total amount"
    - "Clicking the button redirects to Stripe's hosted checkout page"
    - "After successful payment, user lands on /checkout/confirmation with session_id"
    - "Confirmation page shows order details and a success state"
    - "Orders are saved to localStorage"
  artifacts:
    - "src/app/checkout/page.tsx has Stripe integration"
    - "src/app/checkout/confirmation/page.tsx shows order receipt"
---

# Plan 10.2: Stripe Checkout UI + Confirmation

<objective>
Add a "Pay with Stripe" button to /checkout that redirects to Stripe's hosted checkout page. After payment, user returns to a confirmation page showing their order receipt.

Purpose: Complete the payment flow from checkout through Stripe to order confirmation.
Output: Working end-to-end payment flow with Stripe test mode.
</objective>

<context>
Load for context:
- src/app/checkout/page.tsx (existing checkout page)
- src/app/api/create-checkout/route.ts (from Plan 10.1)
- src/lib/checkout.ts (getCheckoutItems)
</context>

<tasks>

<task type="auto">
  <name>Create Order Storage Utility</name>
  <files>src/lib/orders.ts</files>
  <action>
    Create a localStorage utility for orders:

    ```ts
    export type SavedOrder = {
      id: string;
      sessionId: string;
      items: { name: string; category: string; price: number }[];
      totalAmount: number;
      status: 'completed';
      createdAt: string;
    };

    export function getOrders(): SavedOrder[]
    export function saveOrder(order: Omit<SavedOrder, 'createdAt'>): void
    ```

    Store under localStorage key `omegatech_orders`.

    AVOID: Complex order management — just save and retrieve.
  </action>
  <verify>npm run build</verify>
  <done>src/lib/orders.ts exports getOrders and saveOrder.</done>
</task>

<task type="auto">
  <name>Add Stripe Button to Checkout + Create Confirmation Page</name>
  <files>src/app/checkout/page.tsx, src/app/checkout/confirmation/page.tsx</files>
  <action>
    1. **Add "Pay with Stripe" button** to the checkout page below the Grand Total:
       - Full-width, prominent styling (bg-indigo-600 hover:bg-indigo-700 text-white)
       - Shows amount: "Pay ₹1,20,370 with Stripe"
       - Loading state while redirecting

    2. **Implement payment handler**:
       ```ts
       const handleStripeCheckout = async () => {
         setLoading(true);
         const res = await fetch('/api/create-checkout', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
             items: checkoutItems.map(i => ({
               name: i.name,
               category: i.category,
               price: i.price,
             })),
             origin: window.location.origin,
           }),
         });
         const { url } = await res.json();
         // Save items to localStorage before redirect so confirmation can read them
         localStorage.setItem('omegatech_pending_order', JSON.stringify({
           items: checkoutItems,
           totalAmount: totalPrice,
         }));
         window.location.href = url; // Redirect to Stripe
       };
       ```

    3. **Create confirmation page** (`src/app/checkout/confirmation/page.tsx`):
       - 'use client' directive
       - Read `session_id` from URL search params via `useSearchParams()`
       - Retrieve pending order from localStorage
       - Save completed order via `saveOrder()`
       - Show: green checkmark, "Payment Successful!", session ID, itemized list, total
       - "Back to Home" and "Build Another PC" buttons
       - Clear pending order from localStorage after saving

    AVOID: Calling Stripe API from the client side
    AVOID: Auto-clearing the cart
  </action>
  <verify>npm run build</verify>
  <done>Checkout has Stripe button. After payment, confirmation shows receipt.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] "Pay with Stripe" button visible on /checkout
- [ ] Confirmation page renders with order details
- [ ] Build passes cleanly
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
